---

title:  "云平台的基石 -- 虚拟化加容器化"
date:   2015-10-17
categories: container
description: "本文介绍云平台背后的虚拟化和容器化"
summary: "云计算的时代已经全面来临。上至Office365，下至各种云笔记；外有亚马逊，内有阿里云；Iaas, PaaS, SaaS, BaaS, CaaS等一个个新名词不停的映入我们眼帘。
那么在这个神奇的时代，这些神奇的“云端应用”倒底是怎么构建起来的。且让我娓娓道来。"
---

![367f634a]({{ site.BASE_PATH }}/assets/cloud/2015/367f634a.png)

## 1. 引子
云计算的时代已经全面来临。上至Office365，下至各种云笔记；外有亚马逊AWS，内有阿里云；Iaas, PaaS, SaaS, BaaS, CaaS等一个个新名词不停的映入我们眼帘。

那么在这个神奇的时代，这些神奇的“云端应用”倒底是怎么构建起来的？

回答这个问题之前，让我们先来看一下各种“云端应用”一般要满足怎样的非功能性指标。

- 高可用
- 低成本
- 数据安全

这里的每一点扩展开来都可以讲许多章节，而促成这一切的背后的力量就是虚拟化及容器化的合理组合！

## 2. 虚拟化基础
虚拟化通常是指硬件虚拟化，需要CPU指令集支持。某些虚拟化软件（如QEMU）也可以做到软虚拟，当然性能会很糟糕。

虚拟化由内核态加用户态两部分组成，内核态负责各种硬件资源的虚拟（如CPU、内存、声卡、显卡等），通常我们叫做hypervisor，用户态负责虚拟机的呈现和行为控制。

KVM是Linux的内核态虚拟技术，自2007年起集成到Linux内核2.6。用户态则有QEMU，libvirt等工具。

Windows早期有VirtualPC这个产品，属于内核用户态一体的，后来被微软放弃，转而开发了HyperV。HyperV的内核态是Windows的一个核心服务叫做Hypervisor，至于用户态就是一些MMC组件了。

说到虚拟化，不得不提一下业界老大VMware。其丰富的产品组合已经覆盖了企业、教育及个人的各种业务需求了。通常企业会选择vSphere，学生和个人用户可以选择Workstation。

VMware产品固然好，但是费用却不低，所以我个人的选择是Oracle VirtualBox的免费版。（此时正在运行在vbox里面的CoreOS系统内码字）

![3d70cebe]({{ site.BASE_PATH }}/assets/cloud/2015/3d70cebe.png)

**虚拟化的优点**：

- 强隔离性
- 独立的软件系统
- 可移植性

**虚拟化的缺点**：

- 启动虚机比较慢（几十秒到几分钟）
- 性能存在一定损耗
- 虚拟机镜像体积较大

虚拟化是如何帮助我们打造云端产品的呢？答案其实显而易见了，我们可以利用虚拟化技术将一台64核256G内存的服务器“拆分”成16个4核16G内存的虚拟机，从而服务更多业务场景。


## 3. 容器化基础
虚拟化非常美妙，既然已经有了虚拟化，为什么还要容器化呢，容器到底是什么？让我们先从虚拟化的缺点讲起。

虚拟机是一个完整的系统，启动过程和物理机无异，所以是非常消耗时间的。启动慢会拖累云端产品做横向扩展的脚步。刚才提到64核256G内存的服务器切割成16个虚拟机甚好，但是其代价是5%~20%的性能损耗。另外，由于虚拟机是完整的操作系统，所以其镜像体积一般比较大，动辄好几个GB，不宜我们拿来做快速发布和部署。

容器技术很好的解决了这些问题。容器技术得意于Linux的内核级资源管理控制器cgroup，把相关的一些程序组件以打包的方式合并在一起，并且将其启动起来。从使用角度来讲，容器技术和虚拟化技术非常相似，只不过其技术实现完全不一样。

![5c639137]({{ site.BASE_PATH }}/assets/cloud/2015/5c639137.png)

**容器化的优点**：

- 启动速度超快（毫秒级别）
- 性能几乎没有损耗
- 容器镜像体积小（只包含业务程序集，没有操作系统）
- 统一的操作规范
- 可移植性

**容器化的缺点**：

- 隔离性差
- 目前只支持Linux（本文撰写时Windows已经有一个Beta版的容器技术了，呵呵）

容器技术的代表产品是Docker，其为打造云端产品提供了更多灵活部署、伸缩自如的可能性。容器技术当之无愧是2014乃至2015甚至2016最红火的技术，**其优点终将彻底改变云端甚至传统软件开发及运维的工作模式**。

## 4. 混合云
什么样的云才是最好的云？答案是混合云！顾名思义，混合云建立在虚拟化和容器化之上，提供CaaS或SaaS的功能。为什么这么说呢？

首先，云的首要非功能指标是**高可用**。9的个数直接影响产品的业界声誉。硬件虚拟化可以很好的提升这个数字。vSphere提供了一个“漂”的功能，理想状态下可以把一个“活”着的虚机从一个出现硬件故障的主机“漂移”到另一个主机上去，从而达到**基础设施高可用**的境界。

业界还有亚马逊AWS，OpenStack，阿里云等产品也使用了各种“手段”保证虚机实例尽可能做到7*24不宕机。

有了“基础设施高可用”这一层保证之后，再来看软件是怎么做到高可用并且低成本的。

很自然的，容器技术被用来解决这个问题。无论是部署一个Tomcat还是一个Rails应用，对容器来说是没有区别的，通通一个docker run命令解决。压力大了，立马再启一个实例，nginx做负载均衡即可（哦，对了，nginx本身也跑在容器里面哦）。由于容器技术的灵活性和超低性能损耗，高可用和低成本目标达成变得越来越有可能。

## 5. 未来发展
个人猜测，虚拟化技术和容器化技术的终极目标是一致的，即提高计算资源的利用率，降低管理维护成本，所以其最终形态是双剑合璧！值得一提的是，北京的一家创业公司[hyperhq](https://hyper.sh/)已经往这条康庄大道上迈出了坚实的一步，其产品hyper几近完美的融合了虚拟化的隔离性及容器化的轻量性。

![32f2e1ea]({{ site.BASE_PATH }}/assets/cloud/2015/32f2e1ea.png)